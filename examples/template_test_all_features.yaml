# ================================================================================
# ü•∑ NINJA TEST TEMPLATE - Test Alle Tibber Advanced Features
# ================================================================================
#
# Kopieer deze hele template naar Developer Tools ‚Üí Template
# en check of alle features werken!
#
# ================================================================================

# ================================================================================
# üìä SECTIE 1: NIEUWE TODAY/TOMORROW SENSORS
# ================================================================================

=== TODAY PRICE SENSORS (beschikbaar vanaf 00:00) ===
Today Min:  {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_min') }} EUR/kWh
Today Max:  {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_max') }} EUR/kWh
Today Avg:  {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_avg') }} EUR/kWh
Range:      {{ (states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_max')|float - states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_min')|float) | round(4) }} EUR/kWh verschil

=== TOMORROW PRICE SENSORS (beschikbaar vanaf ~14:00) ===
Tomorrow Min: {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_tomorrow_min') }} EUR/kWh
Tomorrow Max: {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_tomorrow_max') }} EUR/kWh
Tomorrow Avg: {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_tomorrow_avg') }} EUR/kWh
Status: {% if states('sensor.tibber_pulse_maanstraat_17_electricity_price_tomorrow_min') == 'unknown' %}‚è≥ Nog niet gepubliceerd{% else %}‚úÖ Beschikbaar!{% endif %}


# ================================================================================
# üìà SECTIE 2: EXTENDED PRICE_INFO_SUMMARY ATTRIBUTES
# ================================================================================

{% set summary = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}

=== STATISTICS ===
{% if summary and summary.stats %}
Today:    Min ‚Ç¨{{ summary.stats.today_min }} | Max ‚Ç¨{{ summary.stats.today_max }} | Avg ‚Ç¨{{ summary.stats.today_avg }}
Tomorrow: {% if summary.stats.tomorrow_available %}Min ‚Ç¨{{ summary.stats.tomorrow_min }} | Max ‚Ç¨{{ summary.stats.tomorrow_max }} | Avg ‚Ç¨{{ summary.stats.tomorrow_avg }}{% else %}Nog niet beschikbaar{% endif %}
{% else %}
‚ö†Ô∏è Geen stats beschikbaar
{% endif %}

=== DATA ARRAYS (aantal entries) ===
{% if summary %}
Today All:    {{ summary.today_all | length }} entries (verwacht: 96 = 24u √ó 4 kwartieren)
Tomorrow All: {{ summary.tomorrow_all | length }} entries (verwacht: 0 of 96)
Next 24h:     {{ summary.next_24h | length }} entries (verwacht: ~40-96)
Next 48h:     {{ summary.next_48h | length }} entries (verwacht: ~40-192)
Upcoming:     {{ summary.upcoming | length }} entries (verwacht: 6)
{% else %}
‚ö†Ô∏è Geen price_info_summary beschikbaar
{% endif %}

=== CURRENT PRICE INFO ===
{% if summary and summary.current %}
Timestamp:  {{ summary.current.startsAt }}
Total:      ‚Ç¨{{ summary.current.total }}/kWh
Energy:     ‚Ç¨{{ summary.current.energy }}/kWh (spotprijs)
Tax:        ‚Ç¨{{ summary.current.tax }}/kWh
Level:      {{ summary.current.level }}
{% else %}
‚ö†Ô∏è Geen current price beschikbaar
{% endif %}


# ================================================================================
# üéØ SECTIE 3: SMART SCHEDULING - CHEAPEST HOURS DETECTION
# ================================================================================

{% set prices = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}
{% set hours_needed = 4 %}

=== GOEDKOOPSTE {{ hours_needed }} UREN IN NEXT 24H ===
{% if prices and prices.next_24h %}
{% set sorted_prices = prices.next_24h | sort(attribute='total') %}
{% for entry in sorted_prices[:hours_needed] %}
  {{ loop.index }}. {{ as_timestamp(entry.startsAt) | timestamp_custom('%a %H:%M') }} - ‚Ç¨{{ entry.total }}/kWh ({{ entry.level }})
{% endfor %}

Totale kosten voor {{ hours_needed }}u @ 3kW: ‚Ç¨{{ (sorted_prices[:hours_needed] | map(attribute='total') | sum * hours_needed * 3) | round(2) }}
Gemiddelde prijs: ‚Ç¨{{ (sorted_prices[:hours_needed] | map(attribute='total') | sum / hours_needed) | round(4) }}/kWh
{% else %}
‚ö†Ô∏è Geen next_24h data
{% endif %}

=== IS HET NU EEN GOEDKOOP MOMENT? ===
{% if prices and prices.next_24h %}
{% set sorted_prices = prices.next_24h | sort(attribute='total') %}
{% set cheapest_times = sorted_prices[:hours_needed] | map(attribute='startsAt') | list %}
{% set now_str = now().isoformat() %}
{% set current_quarter = none %}
{# Zoek huidige kwartier #}
{% for entry in prices.next_24h %}
  {% set start = as_timestamp(entry.startsAt) %}
  {% set end = start + 900 %}
  {% if as_timestamp(now()) >= start and as_timestamp(now()) < end %}
    {% set current_quarter = entry.startsAt %}
  {% endif %}
{% endfor %}
{% if current_quarter in cheapest_times %}
‚úÖ JA! Nu is een goedkoop moment om apparaten in te schakelen!
   Huidige prijs: ‚Ç¨{{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat') }}/kWh
{% else %}
‚è∏Ô∏è Nee, wacht op een goedkoper moment.
   Volgende goedkope tijd: {{ as_timestamp(sorted_prices[0].startsAt) | timestamp_custom('%H:%M') if sorted_prices[0].startsAt > now().isoformat() else 'Later vandaag' }}
{% endif %}
{% endif %}


# ================================================================================
# üí∞ SECTIE 4: SAVINGS CALCULATION
# ================================================================================

{% set stats = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary').stats %}
{% set prices = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}

=== BESPARING DOOR SLIM LADEN ===
{% if prices and prices.next_24h and stats %}
{% set hours = 4 %}
{% set kwh_per_hour = 3.0 %}
{% set sorted = prices.next_24h | sort(attribute='total') %}
{% set cheap_avg = sorted[:hours] | map(attribute='total') | sum / hours %}
{% set total_avg = stats.today_avg %}

Scenario: {{ hours }} uur laden @ {{ kwh_per_hour }} kW
- Als je nu laadt (gemiddeld):  ‚Ç¨{{ (total_avg * hours * kwh_per_hour) | round(2) }}
- Als je slim laadt (goedkoopst): ‚Ç¨{{ (cheap_avg * hours * kwh_per_hour) | round(2) }}
- BESPARING: ‚Ç¨{{ ((total_avg - cheap_avg) * hours * kwh_per_hour) | round(2) }} üí∞

Beste tijden: {{ sorted[:hours] | map(attribute='startsAt') | map('as_timestamp') | map('timestamp_custom', '%H:%M') | list | join(', ') }}
{% else %}
‚ö†Ô∏è Kan besparing niet berekenen
{% endif %}


# ================================================================================
# üìâ SECTIE 5: NEGATIEVE PRIJZEN DETECTIE (voor zonnepanelen)
# ================================================================================

{% set prices = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}

=== NEGATIEVE SPOTPRIJZEN (uitschakelen teruglevering!) ===
{% if prices and prices.next_24h %}
{% set negative_hours = prices.next_24h | selectattr('energy', 'lt', 0) | list %}
{% if negative_hours | length > 0 %}
‚ö†Ô∏è LET OP! {{ negative_hours | length }} periodes met negatieve prijzen gevonden!
{% for entry in negative_hours %}
  - {{ as_timestamp(entry.startsAt) | timestamp_custom('%a %H:%M') }}: ‚Ç¨{{ entry.energy }}/kWh üî¥
{% endfor %}

ACTIE: Zet omvormer UIT tijdens deze tijden om niet bij te betalen!
{% else %}
‚úÖ Geen negatieve prijzen in komende 24u
{% endif %}
{% endif %}

Huidige spotprijs: ‚Ç¨{{ states('sensor.tibber_pulse_maanstraat_17_electricity_base_price_without_surcharge') }}/kWh
Status: {% if states('sensor.tibber_pulse_maanstraat_17_electricity_base_price_without_surcharge')|float < 0 %}üî¥ NEGATIEF - Omvormer UIT!{% else %}‚úÖ Positief{% endif %}


# ================================================================================
# üîç SECTIE 6: DATA QUALITY CHECK
# ================================================================================

{% set prices = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}

=== DATA KWALITEIT CONTROLE ===
{% if prices %}
‚úì price_info_summary bestaat: JA
‚úì Current entry:   {{ 'JA' if prices.current else 'NEE ‚ö†Ô∏è' }}
‚úì Stats:           {{ 'JA' if prices.stats else 'NEE ‚ö†Ô∏è' }}
‚úì Today data:      {{ prices.today_all | length }} entries {{ '‚úì' if prices.today_all | length == 96 else '‚ö†Ô∏è Verwacht 96' }}
‚úì Tomorrow data:   {{ prices.tomorrow_all | length }} entries {{ '‚úì' if prices.tomorrow_all | length in [0, 96] else '‚ö†Ô∏è' }}
‚úì Next 24h data:   {{ prices.next_24h | length }} entries {{ '‚úì' if prices.next_24h | length > 0 else '‚ö†Ô∏è' }}
‚úì Next 48h data:   {{ prices.next_48h | length }} entries {{ '‚úì' if prices.next_48h | length > 0 else '‚ö†Ô∏è' }}
‚úì Upcoming data:   {{ prices.upcoming | length }} entries {{ '‚úì' if prices.upcoming | length == 6 else '‚ö†Ô∏è Verwacht 6' }}

TIMESTAMPS VALIDATIE:
{% if prices.today_all | length > 0 %}
  Eerste today:  {{ prices.today_all[0].startsAt }}
  Laatste today: {{ prices.today_all[-1].startsAt }}
{% endif %}
{% if prices.next_24h | length > 0 %}
  Eerste 24h:    {{ prices.next_24h[0].startsAt }}
  Laatste 24h:   {{ prices.next_24h[-1].startsAt }}
{% endif %}

CURRENCY CHECK:
  Currency: {{ prices.currency if prices.currency else '‚ö†Ô∏è Niet ingesteld' }}
  Source:   {{ prices.source if prices.source else '‚ö†Ô∏è Niet ingesteld' }}
{% else %}
‚ùå price_info_summary NIET BESCHIKBAAR
   - Herlaad de Tibber Advanced integratie
   - Wacht 1-2 minuten
   - Controleer logs voor errors
{% endif %}


# ================================================================================
# üé® SECTIE 7: APEXCHARTS DATA GENERATOR TEST
# ================================================================================

=== APEXCHARTS COMPATIBLE DATA FORMAT ===
{% set prices = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}
{% if prices and prices.next_24h %}
Eerste 5 entries voor ApexCharts data_generator:
{% for entry in prices.next_24h[:5] %}
  [{{ as_timestamp(entry.startsAt) * 1000 }}, {{ entry.total }}],  // {{ as_timestamp(entry.startsAt) | timestamp_custom('%H:%M') }}
{% endfor %}

JavaScript snippet voor ApexCharts:
return entity.attributes.price_info_summary.next_24h.map((entry) => {
  return [new Date(entry.startsAt).getTime(), entry.total];
});

Total entries voor grafiek: {{ prices.next_24h | length }}
{% endif %}


# ================================================================================
# üö¶ SECTIE 8: PRICE LEVEL DISTRIBUTION
# ================================================================================

{% set prices = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}

=== PRIJSNIVEAU VERDELING VANDAAG ===
{% if prices and prices.today_all %}
{% set very_cheap = prices.today_all | selectattr('level', 'eq', 'VERY_CHEAP') | list | length %}
{% set cheap = prices.today_all | selectattr('level', 'eq', 'CHEAP') | list | length %}
{% set normal = prices.today_all | selectattr('level', 'eq', 'NORMAL') | list | length %}
{% set expensive = prices.today_all | selectattr('level', 'eq', 'EXPENSIVE') | list | length %}
{% set very_expensive = prices.today_all | selectattr('level', 'eq', 'VERY_EXPENSIVE') | list | length %}

VERY_CHEAP:      {{ very_cheap }} kwartieren ({{ (very_cheap / 96 * 100) | round(1) }}%)
CHEAP:           {{ cheap }} kwartieren ({{ (cheap / 96 * 100) | round(1) }}%)
NORMAL:          {{ normal }} kwartieren ({{ (normal / 96 * 100) | round(1) }}%)
EXPENSIVE:       {{ expensive }} kwartieren ({{ (expensive / 96 * 100) | round(1) }}%)
VERY_EXPENSIVE:  {{ very_expensive }} kwartieren ({{ (very_expensive / 96 * 100) | round(1) }}%)

Huidig niveau: {{ prices.current.level if prices.current else 'Onbekend' }}
{% endif %}


# ================================================================================
# ‚úÖ SECTIE 9: QUICK STATUS SUMMARY
# ================================================================================

=== ü•∑ NINJA QUICK STATUS ===

{% set summary = state_attr('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat', 'price_info_summary') %}
{% set today_min = states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_min') %}
{% set tomorrow_min = states('sensor.tibber_pulse_maanstraat_17_electricity_price_tomorrow_min') %}

üîã Huidige prijs: {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat') }} EUR/kWh ({{ summary.current.level if summary and summary.current else 'N/A' }})
üìä Today range:   {{ today_min }} - {{ states('sensor.tibber_pulse_maanstraat_17_electricity_price_today_max') }} EUR/kWh
üìÖ Tomorrow:      {{ 'Beschikbaar' if tomorrow_min != 'unknown' else 'Nog niet gepubliceerd (rond 14:00)' }}
üìà Data status:   {{ '‚úÖ Volledig' if summary and summary.today_all | length == 96 else '‚ö†Ô∏è Incompleet' }}
‚è∞ Laatste update: {{ states('sensor.tibber_pulse_maanstraat_17_last_price_update') }}

{% if summary and summary.next_24h %}
{% set sorted = summary.next_24h | sort(attribute='total') %}
üí° Goedkoopste uur komende 24h: {{ as_timestamp(sorted[0].startsAt) | timestamp_custom('%a %H:%M') }} @ ‚Ç¨{{ sorted[0].total }}/kWh
üí∏ Duurste uur komende 24h:     {{ as_timestamp(sorted[-1].startsAt) | timestamp_custom('%a %H:%M') }} @ ‚Ç¨{{ sorted[-1].total }}/kWh
üí∞ Potenti√´le besparing: ‚Ç¨{{ ((sorted[-1].total - sorted[0].total) * 3) | round(2) }} per 3 kWh
{% endif %}

ADVIES:
{% if summary and summary.next_24h %}
{% set sorted = summary.next_24h | sort(attribute='total') %}
{% set now_price = states('sensor.tibber_pulse_maanstraat_17_electricity_price_total_incl_vat') | float %}
{% set avg_price = summary.stats.today_avg if summary.stats else 0.25 %}
{% if now_price < sorted[10].total %}
  ‚úÖ Goed moment om energie-intensieve apparaten te gebruiken!
{% elif now_price > avg_price %}
  ‚è∏Ô∏è Wacht liever op een goedkoper moment.
{% else %}
  ‚öñÔ∏è Gemiddeld moment, niet urgent om te wachten.
{% endif %}
{% endif %}

=== EINDE NINJA TEST ===

# ================================================================================
# üéØ VERWACHTE RESULTATEN
# ================================================================================
#
# ‚úÖ Alle today sensors tonen waarden (niet "unknown")
# ‚úÖ Tomorrow sensors tonen "unknown" v√≥√≥r 14:00, waarden n√° 14:00
# ‚úÖ Today_all heeft 96 entries
# ‚úÖ Tomorrow_all heeft 0 entries v√≥√≥r 14:00, 96 n√° 14:00
# ‚úÖ Next_24h heeft 40-96 entries (afhankelijk van tijd van dag)
# ‚úÖ Current entry timestamp matcht met huidige tijd (binnen 15min)
# ‚úÖ Stats tonen min/max/avg voor vandaag
# ‚úÖ Geen errors of "unavailable" waarschuwingen
#
# ‚ùå Als iets niet klopt:
#    1. Herlaad Tibber Advanced integratie
#    2. Wacht 1-2 minuten
#    3. Check Developer Tools ‚Üí Logs voor "tibber" errors
#    4. Controleer of API token geldig is
#
# ================================================================================
